

import logging
import re
from typing import Optional

import discord
from discord.ext import commands

# ë¡œì»¬ ëª¨ë“ˆ ì„í¬íŠ¸
from config import Config
from decoder import SaveCodeDecoder
from savecode_decoder import decode_savecode2

# ë¡œê¹… ì„¤ì •
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

class SaveCodeBot:
    """ë””ìŠ¤ì½”ë“œ ì„¸ì´ë¸Œì½”ë“œ ë´‡ í´ë˜ìŠ¤"""
    
    def __init__(self):
        self.config = Config()
        self.decoder = SaveCodeDecoder()
        
        # ë´‡ ì¸í…íŠ¸ ì„¤ì •
        intents = discord.Intents.default()
        intents.messages = True
        intents.message_content = True
        
        # ë´‡ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
        self.bot = commands.Bot(command_prefix=self.config.COMMAND_PREFIX, intents=intents)
        self._setup_events()
        self._setup_commands()
    
    def _setup_events(self):
        """ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì„¤ì •"""
        @self.bot.event
        async def on_ready():
            logger.info(f'ë´‡ ì¤€ë¹„ ì™„ë£Œ: {self.bot.user}')
            print(f'ë´‡ ì¤€ë¹„ ì™„ë£Œ: {self.bot.user}')
        
        @self.bot.event
        async def on_command_error(ctx: commands.Context, error: commands.CommandError):
            """ëª…ë ¹ì–´ ì˜¤ë¥˜ ì²˜ë¦¬"""
            if isinstance(error, commands.MissingRequiredArgument):
                await ctx.send("âŒ í•„ìˆ˜ ì¸ìê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤. ëª…ë ¹ì–´ ì‚¬ìš©ë²•ì„ í™•ì¸í•´ì£¼ì„¸ìš”.")
            elif isinstance(error, commands.CommandNotFound):
                await ctx.send("âŒ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ëª…ë ¹ì–´ì…ë‹ˆë‹¤.")
            else:
                logger.error(f"ëª…ë ¹ì–´ ì˜¤ë¥˜: {error}")
                await ctx.send(f"âŒ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {error}")
    
    def _setup_commands(self):
        """ëª…ë ¹ì–´ ì„¤ì •"""
        
        @self.bot.command(name='ê²€ì¦', help='ì„¸ì´ë¸Œì½”ë“œì˜ ìœ íš¨ì„±ì„ ê²€ì¦í•©ë‹ˆë‹¤')
        async def validate_command(ctx: commands.Context, code: str, *, name: str):
            """ì„¸ì´ë¸Œì½”ë“œ ìœ íš¨ì„± ê²€ì¦ ëª…ë ¹ì–´"""
            if not code or not name:
                await ctx.send("âŒ ì½”ë“œì™€ ì´ë¦„ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.")
                return
            
            try:
                # ê¸°ì¡´ í•¨ìˆ˜ì™€ ìƒˆ í•¨ìˆ˜ ë‘˜ ë‹¤ ì‚¬ìš©
                is_valid_legacy = decode_savecode2(code, name)
                is_valid_new = self.decoder.validate_savecode(code, name)
                
                # ê²°ê³¼ê°€ ë‹¤ë¥´ë©´ ë¡œê·¸ì— ê¸°ë¡
                if is_valid_legacy != is_valid_new:
                    logger.warning(f"ê²€ì¦ ê²°ê³¼ ë¶ˆì¼ì¹˜: Legacy={is_valid_legacy}, New={is_valid_new}")
                
                # ê¸°ì¡´ í•¨ìˆ˜ ê²°ê³¼ ìš°ì„  ì‚¬ìš© (í˜¸í™˜ì„± ìœ ì§€)
                result = "âœ… ìœ íš¨í•¨" if is_valid_legacy else "âŒ ìœ íš¨í•˜ì§€ ì•ŠìŒ"
                await ctx.send(f"ê²€ì¦ ê²°ê³¼: {result}")
                
            except Exception as e:
                logger.error(f"ê²€ì¦ ì¤‘ ì˜¤ë¥˜: {e}")
                await ctx.send(f"âŒ ê²€ì¦ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
        
        @self.bot.command(name='ì•„ì´í…œ', help='ì„¸ì´ë¸Œì½”ë“œì—ì„œ ì•„ì´í…œ ëª©ë¡ì„ ì¶”ì¶œí•©ë‹ˆë‹¤')
        async def items_command(ctx: commands.Context, *, code: str):
            """ì„¸ì´ë¸Œì½”ë“œì—ì„œ ì•„ì´í…œ ì¶”ì¶œ ëª…ë ¹ì–´"""
            if not code:
                await ctx.send("âŒ ì„¸ì´ë¸Œì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.")
                return
            
            try:
                items_list = self.decoder.extract_items(code)
                
                if not items_list:
                    await ctx.send("âŒ ì•„ì´í…œ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
                    return
                
                response = "\n".join(items_list)
                await ctx.send(f"**ì„¸ì´ë¸Œì½”ë“œ ì•„ì´í…œ ì¶”ì¶œ ê²°ê³¼:**\n```\n{response}\n```")
                
            except Exception as e:
                logger.error(f"ì•„ì´í…œ ì¶”ì¶œ ì¤‘ ì˜¤ë¥˜: {e}")
                await ctx.send(f"âŒ ì•„ì´í…œ ì¶”ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
        
        @self.bot.command(name='ë¡œë“œ', help='ì„¸ì´ë¸Œì½”ë“œë¥¼ ê²€ì¦í•˜ê³  ì•„ì´í…œì„ ì¶”ì¶œí•©ë‹ˆë‹¤')
        async def load_command(ctx: commands.Context, name: str, *, code: str):
            """ì„¸ì´ë¸Œì½”ë“œ ê²€ì¦ ë° ì•„ì´í…œ ì¶”ì¶œ ëª…ë ¹ì–´"""
            if not code or not name:
                await ctx.send("âŒ ì½”ë“œì™€ ì´ë¦„ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.")
                return
            
            try:
                raw_codes = re.split(r'[;\n,]+|\s{1,}', code.strip()) 
                codes = [c.strip().upper() for c in raw_codes if c.strip()]
                for code in codes:
                    print(f"[DEBUG] ë¡œë“œëœ ì½”ë“œë“¤: {code}")  # ë””ë²„ê·¸ìš© ì¶œë ¥
                # ê²€ì¦
                    is_valid = decode_savecode2(code, name)
                    result = "âœ… ìœ íš¨í•¨" if is_valid else "âŒ ìœ íš¨í•˜ì§€ ì•ŠìŒ"
                    
                    # ì•„ì´í…œ ì¶”ì¶œ
                    items_list = self.decoder.extract_items(code)
                    response = "\n".join(items_list)
                    
                    # ê²°ê³¼ ì „ì†¡
                    await ctx.send(f"**ê²€ì¦ ê²°ê³¼:** {result}")
                    if items_list:
                        await ctx.send(f"**ì„¸ì´ë¸Œì½”ë“œ ì•„ì´í…œ ì¶”ì¶œ ê²°ê³¼:**\n```\n{response}\n```")
                
            except Exception as e:
                logger.error(f"ë¡œë“œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: {e}")
                await ctx.send(f"âŒ ë¡œë“œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
        
        @self.bot.command(name='ë„ì›€ë§', help='ì‚¬ìš© ê°€ëŠ¥í•œ ëª…ë ¹ì–´ë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤')
        async def help_command(ctx: commands.Context):
            """ë„ì›€ë§ ëª…ë ¹ì–´"""
            embed = discord.Embed(
                title="ğŸ¤– ì„¸ì´ë¸Œì½”ë“œ ë´‡ ë„ì›€ë§",
                description="ì„¸ì´ë¸Œì½”ë“œ ê´€ë ¨ ê¸°ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤.",
                color=0x00ff00
            )
            
            embed.add_field(
                name="/ê²€ì¦ <ì½”ë“œ> <ì´ë¦„>",
                value="ì„¸ì´ë¸Œì½”ë“œì˜ ìœ íš¨ì„±ì„ ê²€ì¦í•©ë‹ˆë‹¤.",
                inline=False
            )
            
            embed.add_field(
                name="/ì•„ì´í…œ <ì½”ë“œ>",
                value="ì„¸ì´ë¸Œì½”ë“œì—ì„œ ì•„ì´í…œ ëª©ë¡ì„ ì¶”ì¶œí•©ë‹ˆë‹¤.",
                inline=False
            )
            
            embed.add_field(
                name="/ë¡œë“œ <ì´ë¦„> <ì½”ë“œ>",
                value="ì„¸ì´ë¸Œì½”ë“œë¥¼ ê²€ì¦í•˜ê³  ì•„ì´í…œì„ ì¶”ì¶œí•©ë‹ˆë‹¤.",
                inline=False
            )
            
            embed.add_field(
                name="/ë„ì›€ë§",
                value="ì´ ë„ì›€ë§ì„ í‘œì‹œí•©ë‹ˆë‹¤.",
                inline=False
            )
            
            await ctx.send(embed=embed)
    
    def run(self):
        """ë´‡ ì‹¤í–‰"""
        try:
            logger.info("ë´‡ì„ ì‹œì‘í•©ë‹ˆë‹¤...")
            self.bot.run(self.config.BOT_TOKEN)
        except Exception as e:
            logger.error(f"ë´‡ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜: {e}")
            raise


def main():
    """ë©”ì¸ í•¨ìˆ˜"""
    try:
        bot = SaveCodeBot()
        bot.run()
    except KeyboardInterrupt:
        logger.info("ë´‡ì´ ì‚¬ìš©ìì— ì˜í•´ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.")
    except Exception as e:
        logger.error(f"ë´‡ ì‹¤í–‰ ì¤‘ ì¹˜ëª…ì  ì˜¤ë¥˜: {e}")
        raise


if __name__ == "__main__":
    main()
